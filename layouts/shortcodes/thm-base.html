{{- /* Shared renderer for theorem-like environments with numbering and references */ -}}

{{- define "thm-block" -}}
  {{- $ctx := .ctx -}}
  {{- $kind := .kind -}}
  {{- $page := $ctx.Page -}}
  {{- $pageKey := $page.RelPermalink -}}

  {{- $registryKey := printf "thm_registry:%s" $pageKey -}}

  {{- $title := $ctx.Get "title" -}}
  {{- $idParam := $ctx.Get "id" -}}

  {{- /* NEW: numbering group. Envs that should share numbering use the same group. */ -}}
  {{- $group := $ctx.Get "group" | default "main" -}}
  {{- $counterKey := printf "thm_counter:%s:%s" $pageKey (lower $group) -}}

  {{- $star := false -}}
  {{- range $key := slice "star" "starred" "unnumbered" -}}
    {{- with $ctx.Get $key -}}
      {{- if or (eq . true) (eq (printf "%v" .) "true") -}}
        {{- $star = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- $number := "" -}}
  {{- if not $star -}}
    {{- $current := default 0 ($page.Store.Get $counterKey) -}}
    {{- $next := add $current 1 -}}
    {{- $page.Store.Set $counterKey $next -}}
    {{- $number = $next -}}
  {{- end -}}

  {{- $anchorBase := "" -}}
  {{- if $idParam -}}
    {{- $anchorBase = $idParam -}}
  {{- else if and (not $star) $number -}}
    {{- /* NEW: anchor also reflects group, to avoid collisions across groups */ -}}
    {{- $anchorBase = printf "%s-%v" (lower $group) $number -}}
  {{- end -}}

  {{- $anchor := "" -}}
  {{- if $anchorBase -}}
    {{- $anchor = anchorize $anchorBase -}}
  {{- end -}}

  {{- $registry := default (dict) ($page.Store.Get $registryKey) -}}
  {{- if $idParam -}}
    {{- /* NEW: store group in registry entry (useful for ref rendering) */ -}}
    {{- $entry := dict "kind" $kind "group" $group "number" $number "star" $star "anchor" $anchor -}}
    {{- $registry = merge $registry (dict $idParam $entry) -}}
  {{- end -}}
  {{- $page.Store.Set $registryKey $registry -}}

  <div class="thm-block kind-{{ lower $kind }}{{ if $star }} thm-star{{ end }}{{ if $title }} has-title{{ end }}"{{ if $anchor }} id="{{ $anchor }}"{{ end }}>
    <div class="thm-header">
      <span class="thm-title">
        {{ $kind }}
        {{- if and (not $star) $number }} {{ $number }}{{ end -}}
        {{- with $title }} ({{ . }}){{ end -}}.
      </span>
    </div>
    <div class="thm-body">
      {{- $ctx.Inner | $ctx.Page.RenderString -}}
    </div>
  </div>
{{- end -}}
