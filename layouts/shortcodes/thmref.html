{{- /* layouts/shortcodes/thmref.html */ -}}

{{- $id := .Get 0 | default (.Get "id") -}}
{{- if not $id -}}
  {{- errorf "thmref: missing id" -}}
{{- end -}}
{{- $fmt := .Get "fmt" | default "kind-number" -}}

{{- $page := .Page -}}
{{- $inSchema := $page.Scratch.Get "IN_SCHEMA_JSON" -}}
{{- if $inSchema -}}
  {{- /* schema_json: keep it inert */ -}}
  <span class="thm-ref">{{ $id }}</span>
  {{- return -}}
{{- end -}}

{{- $registryKey := printf "thm_registry:%s" $page.RelPermalink -}}
{{- $missingKey  := printf "thm_missing:%s"  $page.RelPermalink -}}

{{- $registry := default (dict) ($page.Store.Get $registryKey) -}}
{{- $e := index $registry $id -}}

{{- if $e -}}
  {{- /* resolved immediately */ -}}
  {{- $kind := printf "%v" (index $e "kind") -}}
  {{- $num := printf "%v" (index $e "number") -}}
  {{- $star := printf "%v" (index $e "star") -}}
  {{- $anchor := printf "%v" (index $e "anchor") -}}
  {{- $title := printf "%v" (index $e "title") -}}

  {{- if eq $kind "<nil>" -}}{{- $kind = "Theorem" -}}{{- end -}}
  {{- if eq $num "<nil>" -}}{{- $num = "" -}}{{- end -}}
  {{- if eq $anchor "<nil>" -}}{{- $anchor = "" -}}{{- end -}}
  {{- if eq $title "<nil>" -}}{{- $title = "" -}}{{- end -}}

  {{- $isStar := false -}}
  {{- if or (eq $star "true") (eq $star "1") (eq $star "True") -}}
    {{- $isStar = true -}}
  {{- end -}}

  {{- $text := "" -}}
  {{- if eq $fmt "number" -}}
    {{- $text = cond (ne $num "") $num $id -}}
  {{- else if eq $fmt "kind-number-title" -}}
    {{- if $isStar -}}
      {{- $text = $kind -}}
    {{- else if ne $num "" -}}
      {{- $text = printf "%v %v" $kind $num -}}
    {{- else -}}
      {{- $text = $kind -}}
    {{- end -}}
    {{- if ne $title "" -}}
      {{- $text = printf "%v (%v)" $text $title -}}
    {{- end -}}
  {{- else -}}
    {{- /* kind-number */ -}}
    {{- if $isStar -}}
      {{- $text = $kind -}}
    {{- else if ne $num "" -}}
      {{- $text = printf "%v %v" $kind $num -}}
    {{- else -}}
      {{- $text = $kind -}}
    {{- end -}}
  {{- end -}}

  {{- if $anchor -}}
    <a class="thm-ref" href="{{ $page.RelPermalink }}#{{ $anchor }}">{{ $text }}</a>
  {{- else -}}
    <span class="thm-ref">{{ $text }}</span>
  {{- end -}}
  {{- return -}}
{{- end -}}

{{- /* unresolved now: record missing (as map) and emit a pending anchor to be filled by footer JS */ -}}
{{- $raw := $page.Store.Get $missingKey -}}
{{- $missing := dict -}}  
{{- if $raw -}}
  {{- $t := printf "%T" $raw -}}
  {{- if hasPrefix $t "map[" -}}
    {{- $missing = $raw -}}
  {{- else -}}
    {{- $missing = dict (printf "%v" $raw) true -}}
  {{- end -}}
{{- end -}}
{{- if not (isset $missing $id) -}}
  {{- $missing = merge $missing (dict $id true) -}}
  {{- $page.Store.Set $missingKey $missing -}}
{{- end -}}

<a class="thm-ref thm-ref-pending" data-thm-id="{{ $id }}" data-thm-fmt="{{ $fmt }}" href="#"></a>
